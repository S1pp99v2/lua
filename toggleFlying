-- ===================== 【独立飞行模块】 =====================
-- 功能：纯飞行逻辑，无UI，快捷键F开关
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local IsFlying = false
local FlySpeed = 50
local Character, Humanoid, RootPart = nil, nil, nil

-- 安全获取角色部件
local function getCharacterParts()
    local success, result = pcall(function()
        Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        Humanoid = Character:WaitForChild("Humanoid", 10)
        RootPart = Character:WaitForChild("HumanoidRootPart", 10)
        return true
    end)
    if not success then
        warn("获取角色失败：" .. result)
        return false
    end
    return true
end

-- 切换飞行状态
local function toggleFlying()
    if not getCharacterParts() then return end
    
    IsFlying = not IsFlying
    if IsFlying then
        Humanoid.PlatformStand = true
        Humanoid.WalkSpeed = 0
        print("[✈️] 飞行已开启 | WASD+空格+Shift控制")
    else
        Humanoid.PlatformStand = false
        Humanoid.WalkSpeed = LocalPlayer:GetAttribute("WalkSpeed") or 16
        print("[✈️] 飞行已关闭")
    end
end

-- 飞行控制逻辑
local function handleFlying()
    if not IsFlying or not RootPart then return end
    
    local moveDir = Vector3.new()
    if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir += Vector3.new(0, 0, -1) end
    if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir += Vector3.new(0, 0, 1) end
    if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir += Vector3.new(-1, 0, 0) end
    if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir += Vector3.new(1, 0, 0) end
    if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir += Vector3.new(0, 1, 0) end
    if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then moveDir += Vector3.new(0, -1, 0) end
    
    local camera = workspace.CurrentCamera
    local lookDir = camera.CFrame.LookVector
    lookDir = Vector3.new(lookDir.X, 0, lookDir.Z).Unit
    local rightDir = lookDir:Cross(Vector3.new(0, 1, 0))
    
    local finalDir = (lookDir * -moveDir.Z) + (rightDir * moveDir.X) + Vector3.new(0, moveDir.Y, 0)
    RootPart.Velocity = finalDir.Unit * FlySpeed
end

-- 初始化飞行模块
local function initFlyModule()
    -- 绑定F键切换飞行
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if input.KeyCode == Enum.KeyCode.F then
            toggleFlying()
        end
    end)
    
    -- 每帧处理飞行
    RunService.RenderStepped:Connect(handleFlying)
    
    -- 角色重生重置
    LocalPlayer.CharacterAdded:Connect(function()
        task.wait(0.5)
        IsFlying = false
    end)
    
    print("✅ 飞行模块加载成功 | F键切换飞行")
end

-- 启动飞行模块
initFlyModule()
